import pdfplumber
import pandas as pd
import re

def extract_additional_columns(text):
    sub_non_sub = "Not Extracted"
    program_type = "Not Extracted"
    program_location = "Not Extracted"
    start_date = "Not Extracted"
    end_date = "Not Extracted"
    
    if "Subsidized" in text:
        sub_non_sub = "Subsidized"
    elif "Non-Subsidized" in text:
        sub_non_sub = "Non Subsidized"
    
    if "Low rate Program" in text:
        program_type = "Low rate"
    
    location_match = re.search(r'23my|24 my', text)
    if location_match:
        program_location = location_match.group(0)
    
    date_match = re.search(r'(\w+ \d{1,2}, \d{4}) - (\w+ \d{1,2}, \d{4})', text)
    if date_match:
        start_date, end_date = date_match.groups()
    
    return sub_non_sub, program_type, program_location, start_date, end_date

def process_pdf(file_path):
    with pdfplumber.open(file_path) as pdf:
        results = []

        for page_number, page in enumerate(pdf.pages, start=1):
            page_text = page.extract_text()
            tables = page.extract_tables()

            processed_tables = []
            for table in tables:
                df = pd.DataFrame(table)
                df.dropna(how='all', axis=0, inplace=True)
                df.dropna(how='all', axis=1, inplace=True)
                df.ffill(axis=0, inplace=True)
                
                sub_non_sub, program_type, program_location, start_date, end_date = extract_additional_columns(page_text)
                df['Sub/Non Sub'] = sub_non_sub
                df['Program Type'] = program_type
                df['Program Location'] = program_location
                df['Start Date'] = start_date
                df['End Date'] = end_date
                
                processed_tables.append(df)
            
            results.append({
                'Page Num': page_number,
                'Text in the Page': page_text,
                'Tables in page modified': processed_tables
            })

    return results

# Replace with the actual path to your PDF file
pdf_file_path = '/mnt/data/your_pdf_file.pdf'
data = process_pdf(pdf_file_path)

# Printing the results for verification
for page_data in data:
    print(f"Page Number: {page_data['Page Num']}")
    print(f"Text in the Page:\n{page_data['Text in the Page']}")
    for idx, table in enumerate(page_data['Tables in page modified']):
        print(f"Table {idx+1} in Page {page_data['Page Num']}:")
        print(table)

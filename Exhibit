import fitz  # PyMuPDF
import tabula
import pandas as pd

def extract_text_and_tables(pdf_path):
    doc = fitz.open(pdf_path)
    data = []

    for page_num in range(len(doc)):
        page = doc.load_page(page_num)
        text = page.get_text("text")
        
        # Extract tables using tabula
        tables = tabula.read_pdf(pdf_path, pages=page_num + 1, multiple_tables=True)

        # Extract text before each table
        blocks = page.get_text("blocks")
        paragraphs_before_tables = []
        current_paragraph = ""
        table_coords = [table.bbox for table in tables] if tables else []

        for block in blocks:
            block_bbox = block[:4]
            block_text = block[4]
            if any(fitz.Rect(block_bbox).intersects(fitz.Rect(table_bbox)) for table_bbox in table_coords):
                paragraphs_before_tables.append(current_paragraph.strip())
                current_paragraph = ""
            else:
                current_paragraph += block_text + "\n"
        
        # Add the last paragraph if there are tables but no ending paragraph detected
        if tables:
            paragraphs_before_tables.append(current_paragraph.strip())

        page_data = {
            "Page Num": page_num + 1,
            "Text in the Page": text,
            "Tables in page": tables,
            "Text before each Table": paragraphs_before_tables
        }
        
        data.append(page_data)

    return data

# Example usage:
pdf_path = 'example.pdf'  # Replace with the path to your PDF file
extracted_data = extract_text_and_tables(pdf_path)

# Convert to DataFrame for better visualization
df = pd.DataFrame(extracted_data)
print(df)

# If needed, save the DataFrame to a CSV file
df.to_csv('extracted_data.csv', index=False)

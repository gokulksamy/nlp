import pdfplumber
import pandas as pd
import re

# Function to extract tables and their preceding text from a PDF
def extract_tables_with_text(pdf_path):
    with pdfplumber.open(pdf_path) as pdf:
        all_data = []
        for page in pdf.pages:
            # Extract text from the page
            page_text = page.extract_text()
            # Extract tables from the page
            tables = page.extract_tables()

            if page_text and tables:
                # Split the text into lines
                lines = page_text.split('\n')
                for i, table in enumerate(tables):
                    # Assuming the table name is the last non-empty line before the table
                    table_name = None
                    for line in reversed(lines):
                        if line.strip():
                            table_name = line.strip()
                            break

                    # Create a DataFrame from the table
                    df = pd.DataFrame(table[1:], columns=table[0])
                    all_data.append((table_name, df))
                    
                    # Remove used lines to avoid using the same name for the next table
                    lines = lines[:-len(table)]

        return all_data

# Path to your PDF file
pdf_path = 'path_to_your_file.pdf'

# Extract tables and their names
tables_with_names = extract_tables_with_text(pdf_path)

# Print the results
for name, df in tables_with_names:
    print(f"Table Name: {name}")
    print(df)
    print("\n")

# You can also save these tables to separate files if needed
for name, df in tables_with_names:
    df.to_csv(f"{name}.csv", index=False)
